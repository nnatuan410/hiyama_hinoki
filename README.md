# 仕様書

## UI-CODE バージョン
- version: 1.3.0
- update: 2020/12/03

## 動作確認環境
- OS: macOS 10.15.7
- node: v10.21.0
- npm: 6.14.9

## ディレクトリ構造
- _src/_ : 実際に作業を行うディレクトリ
    Git でバージョン管理される
- _dist/_ : 実際にサーバにアップロードする生成されたディレクトリ
    cms や.htaccess 以外は直接編集するべきでない
    Git でバージョン管理されない
- _node_modules/_ : `npm install` などによって生成されるパッケージがインストールされるディレクトリ
- _.vscode/_ : プロジェクトで共有する VSCodeの設定や拡張機能などが設定されているディレクトリ
- _package.json_ : 依存パッケージや同期サーバの ssh アドレス、npm scripts 等が書かれたファイル
- _package-lock.json_ : `npm install` などによって生成されるパッケージのバージョンが書かれたファイル
- _gulpfile.js_ : Gulp のタスクが書かれたファイル
- _rsync.js_ : rsync を質問形式で実行するスクリプト
- _rsync-\*.txt_ : サーバと同期するファイルの除外設定が書かれたファイル
- _.gitignore_ : Git で管理しないファイルが指定されたファイル
- _.editorconfig_ : インデントサイズ等の設定ファイル
- _.prettierrc : Prettierの整形設定ファイル
- _.browserslistrc_ : autoprefixer 等で対象とするブラウザの設定

## package.json
パッケージの情報、依存パッケージの一覧が記述されたファイル
このファイルを元に gulp で使うパッケージなどを `npm install` でインストールする
既存のリポジトリからクローンしてきた場合には `npm install` ではなく、 `npm ci` でパッケージをインストールする
このファイルにディレクトリ名やサーバの URL の情報もまとめておく

### 変数（プロジェクトによって書き換える箇所）
- _name_: プロジェクトの英字名（スラッシュなどは使えない）（**要確認**）
- _config_: プロジェクトで共通で利用する情報
    - _server_: rsync で同期するサーバの ssh アドレス
        - _test_: テストサーバの ssh アドレス
        - _production_: 本番サーバの ssh アドレス
    - _dir_: ディレクトリ名
        - _site_: サイトのディレクトリ名（**要確認**）
        - _git_: .git/のあるディレクトリ 基本的に master/
        - _src_: 作業ディレクトリ 基本的に src/
        - _dist_: 成果物ディレクトリ 基本的に dist/
        - _cms_: wordpress ファイルの入っているディレクトリ（作業・成果物ディレクトリからのパス） 基本的に cms/
    - _branch_: ブランチ名
        - _default_: デフォルトのブランチ 基本的に master
        - _production_: 本番用のブランチ 基本的に production
        - _autodeploy_: プッシュ時に自動デプロイするブランチの配列

## Gulp
src ディレクトリのファイルを変換・圧縮し、
dist ディレクトリにサーバにアップロードできるファイルを書き出す。

### 導入手順
1. package.json, gulpfile.js があることを確認する
2. 既存のリポジトリからクローンしてきた場合（package-lock.json がある）は `npm ci` を実行してパッケージをインストールする
3. 新しく作るプロジェクトの場合は`npm i` または `npm install` を実行してパッケージをインストールする
4. （メッセージに従い、必要があれば `npm audit fix` を実行）
5. 必要があらばローカル環境の設定をした env.json を配置する
6. Gulp のタスクを実行

### 主なタスク
| タスク名  | 処理                                 | コマンド                                        |
| :-------: | :----------------------------------- | :---------------------------------------------- |
|   build   | 成果物を全て生成する                 | `npm run build` または `npx gulp build`         |
| build:doc | 画像以外を全て生成する               | `npx gulp build:doc`                            |
|  rebuild  | 成果物を全て削除してから生成する     | `npm run rebuild` または `npx gulp rebuild`     |
|  default  | 変更ファイルのみ変換し、ブラウザ更新 | `npm run dev` または `npx gulp`                 |
|  favicon  | svg 等から favicon を生成            | `npm run favicon` または `npx gulp favicon`     |
|   clean   | dist のファイルを削除                | `npm run clean` または `npx gulp clean`         |
| clean:dry | clean で削除するファイル一覧を出力   | `npm run clean:dry` または `npx gulp clean:dry` |

## rsync
dist ディレクトリの内容をサーバと同期する。
rsync.js で質問形式で実行できる。

### 前準備
1. rsync コマンドが使えることを確認する（ `rsync -h` などを実行して確認）
2. 対象サーバが ssh 接続できるか確認する
3. テストサーバに公開鍵を登録しておく
4. サーバにサイト名・ブランチ名と同じディレクトリがあることを確認（無いとアップロードできない）

### タスク一覧
|  タスク名  | 処理                                 | コマンド                           |
| :--------: | :----------------------------------- | :--------------------------------- |
|    sync    | 質問形式で同期する                   | `npm run sync` または `node rsync` |
| build+sync | ビルド後に質問形式で同期する         | `npm run sync:build`               |
|  autosync  | プッシュ時に自動でビルドと同期を行う | プッシュ時に自動で実行される       |

### 同期設定の質問

#### ブランチ名のディレクトリと同期しますか [yes/main/no]
|     答え方     | 処理                                   |
| :------------: | :------------------------------------- |
|   `yes`, `y`   | ブランチ名と同じディレクトリと同期する |
|  `main`, `m`   | デフォルトブランチに同期               |
| `no`（その他） | 同期を行わない                         |

#### 上記サーバーと同期しますか [yes/dry/no]
|     答え方     | 処理                                              |
| :------------: | :------------------------------------------------ |
|   `yes`, `y`   | 実際に同期を行う                                  |
|   `dry`, `d`   | 同期を行うファイルリストを表示するのみ（dry-run） |
| `no`（その他） | 同期を行わない                                    |

#### 同期の除外設定を選択 [update/all/system/cancel]
|       答え方       | 処理                                                                      |
| :----------------: | :------------------------------------------------------------------------ |
|   `update`, `u`    | サーバ側で変更されうる wordpress システムファイルなどを除いてアップロード |
|     `all`, `a`     | 全てアップロード                                                          |
|   `system`, `s`    | サーバ側で変更されうる wordpress システムファイルなどをダウンロード       |
| `cancel`（その他） | 同期を行わない                                                            |

## 量産スクリプト
src/config/json/setting.json のディレクトリ情報に基づき、下層雛形を src/ 内に量産する

### 仕様
- 2階層までの量産が可能
- 1階層には src/sub/ , 2階層には src/sub/sub/ の内容がコピーされる
- 上記の雛形が無い場合は、対応する階層の量産は行われない
- すでにディレクトリが存在する場合は、そのディレクトリの量産はスキップされる

### タスク一覧
| タスク名 | 処理               | コマンド                          |
| :------: | :----------------- | :-------------------------------- |
|   mass   | 下層雛形を量産する | `npm run mass` または `node mass` |

## SASS

### ディレクトリ構造
- common/css/
    - base/
        - \_reset.scss : リセット CSS
        - \_support.scss : mb20 などの汎用クラス
        - \_var.scss : 変数・ミックスイン
    - module/ : パーツ・mixin
        - \_box.scss
        - \_tit.scss
        - \_list.scss
        - wire/ : ワイヤーモジュールの変数・mixin
    - common.scss : 全ページ共通で読み込み CSS
    - sub.scss : 下層で読み込む CSS

`@import`で読み込むファイルは "\_" から始まるファイル名にする

### メディアクエリ
`@media` の代わりに以下のように書くことができる

```scss
@include sp {
	// 750px以下の指定
}

@include pc {
	// 751px以上の指定
}

@include retina {
	// 高解像度ディスプレイの指定
}

@include mq(750px, 1300px) {
	// 751px〜1300px時の指定
}
```

## Git
プログラムのソースコードなどの変更履歴を記録・追跡するための分散型バージョン管理システムである。（Wikipedia）

### 前準備
1. git をインストール
2. GitLab, Bitbucket 等ホスティングサービスのアカウントを取得
3. グローバルに git のユーザー名とメールアドレスを config に設定する
4. ホスティングサービスに SSH 公開鍵を登録

### ブランチモデル
GitLab flow 風なブランチモデルです。

- _master_ : 開発ブランチ
    複数人で作業する場合は直接コミットしないようにする
    テストサーバにデプロイする予定
- _{namae}_ : 実際にローカルで作業するブランチ 作業者名を付けて競合を避ける
- _pre-production_ : 提出用ブランチ
    テストサーバのクライアント提出用ディレクトリにデプロイする予定
    基本的にマージするだけ
- _production_ : 本番公開用ブランチ
    本番サーバにデプロイする予定
    基本的にマージするだけ

### コミットメッセージ
以下のフォーマットで記入する

```
1行目: 変更内容の要約
2行目: 空行
3行目以降: 必要があれば詳細
```

1行目の最初に以下のようなプリフィックスを付けて作業内容が分かりやすいようにする

- _fix_ : 修正
- _add_ : 新規追加
- _update_ : 機能修正（バグではない）
- _change_ : 仕様変更
- _clean_ : 整理
- _merge_ : 統合

### gitignore
node_modules/ , dist/ , env.json を無視するよう設定している

#### dist ディレクトリでのみ管理するファイル
- wordpress の themes の tmp 以外のファイル
- .htaccess

### リモートリポジトリを変更する
`git remote -vv` で登録されている URL がリモートリポジトリと異なる場合、
下記例のようなコマンドで変更する。

```
git remote set-url origin git@gitlab.com:u-active/management-site/xxxxxxxx.git
```

## env.json
ローカル開発環境の設定ファイル
git でバージョン管理しない
雛形の env-sample.json から複製する

### プロパティ
- _browserSync_: gulp のライブリロードの設定
    - _host_: ローカルサーバのホスト名
    - _path_: ローカル環境のサイトのディレクトリへのパス
    - _port_: ローカルサーバのポート番号
